<!DOCTYPE html>
<html>
<head>
    <title>Agent Dashboard</title>
    <style>
        body { 
            font-family: Arial; 
            margin: 0; 
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
            min-height: 100vh;
        }
        .header { 
            background: white;
            padding: 20px;
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .logo { font-size: 24px; }
        .content { padding: 20px; }
        .form-section { 
            background: white;
            margin: 20px 0; 
            padding: 20px; 
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        input, select, button { 
            padding: 10px; 
            margin: 5px; 
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        button { 
            background: #764ba2; 
            color: white; 
            border: none;
            cursor: pointer;
        }
        button:hover { background: #6a4190; }
        .logout { 
            background: #e74c3c; 
            color: white; 
            padding: 10px 20px;
            text-decoration: none;
            border-radius: 5px;
        }
        .tab-btn {
            background: #ecf0f1;
            color: #333;
            margin-right: 10px;
        }
        .tab-btn.active {
            background: #764ba2;
            color: white;
        }
        .match-item {
            border: 1px solid #ddd;
            padding: 10px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
        }
        .match-item:hover { background: #f0f0f0; }
        .match-item.selected { background: #e8f5e8; border-color: #27ae60; }
    </style>
</head>
<body>
    <div class="header">
        <div><span class="logo">üëÆ</span> Agent Dashboard</div>
        <a href="/logout" class="logout">Logout</a>
    </div>
    
    <div class="content">
        <div class="form-section">
            <h2>üìä Dashboard Overview</h2>
            <div style="display: flex; gap: 20px; margin: 20px 0;">
                <div style="background: #3498db; color: white; padding: 15px; border-radius: 8px; flex: 1; text-align: center;">
                    <div style="font-size: 24px; font-weight: bold;" id="totalItems">0</div>
                    <div>Total Items</div>
                </div>
                <div style="background: #e74c3c; color: white; padding: 15px; border-radius: 8px; flex: 1; text-align: center;">
                    <div style="font-size: 24px; font-weight: bold;" id="lostItems">0</div>
                    <div>Lost Items</div>
                </div>
                <div style="background: #27ae60; color: white; padding: 15px; border-radius: 8px; flex: 1; text-align: center;">
                    <div style="font-size: 24px; font-weight: bold;" id="foundItems">0</div>
                    <div>Found Items</div>
                </div>
                <div style="background: #f39c12; color: white; padding: 15px; border-radius: 8px; flex: 1; text-align: center;">
                    <div style="font-size: 24px; font-weight: bold;" id="matchedItems">0</div>
                    <div>Matched</div>
                </div>
            </div>
            <div style="background: #ecf0f1; padding: 15px; border-radius: 8px; margin: 10px 0;">
                <strong>üì± Most Lost Items:</strong> <span id="commonItems">Loading...</span>
            </div>
        </div>
        
        <div class="form-section">
            <h2>üîç Item Management</h2>
            <div style="margin-bottom: 20px;">
                <button onclick="showSection('report')" class="tab-btn active" id="reportTab">Report Item</button>
                <button onclick="showSection('match')" class="tab-btn" id="matchTab">Match Items</button>
                <button onclick="showSection('all')" class="tab-btn" id="allTab">All Items</button>
            </div>
            
            <div id="reportSection">
                <form id="lostForm">
                    <input type="text" name="name" placeholder="Item Name" required/>
                    <input type="text" name="description" placeholder="Description" required/>
                    <input type="text" name="location" placeholder="Location" required/>
                    <input type="date" name="date" required/>
                    <input type="text" name="contact" placeholder="Contact Info" required/>
                    <select name="status" required>
                        <option value="Lost">Lost Item</option>
                        <option value="Found">Found Item</option>
                    </select>
                    <button type="submit">Report Item</button>
                </form>
            </div>
            
            <div id="matchSection" style="display: none;">
                <h3>üîó Match Lost & Found Items</h3>
                <div style="display: flex; gap: 20px;">
                    <div style="flex: 1;">
                        <h4>Lost Items</h4>
                        <div id="lostItemsList"></div>
                    </div>
                    <div style="flex: 1;">
                        <h4>Found Items</h4>
                        <div id="foundItemsList"></div>
                    </div>
                </div>
                <div style="text-align: center; margin: 20px 0;">
                    <button onclick="matchSelectedItems()" style="background: #27ae60;">Match Selected Items</button>
                </div>
            </div>
            
            <div id="allSection" style="display: none;">
                <input type="text" id="searchInput" placeholder="Search items..." style="width: 70%; margin-right: 10px;"/>
                <button onclick="searchItems()">Search</button>
                <div id="itemsList" style="margin-top: 20px;"></div>
            </div>
        </div>
    </div>
    
    <script>
        let selectedLostItem = null;
        let selectedFoundItem = null;
        let allItems = [];
        
        document.getElementById('lostForm').onsubmit = async function(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            const response = await fetch('/api/items', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            if (response.ok) {
                alert('Item Reported Successfully!');
                e.target.reset();
                loadItems();
            }
        };
        
        async function loadItems() {
            const response = await fetch('/api/items');
            if (response.ok) {
                allItems = await response.json();
                updateDashboard();
                displayAllItems();
                displayMatchingItems();
            }
        }
        
        function updateDashboard() {
            const total = allItems.length;
            const lost = allItems.filter(item => item.status === 'Lost').length;
            const found = allItems.filter(item => item.status === 'Found').length;
            const matched = allItems.filter(item => item.status === 'Matched').length;
            
            document.getElementById('totalItems').textContent = total;
            document.getElementById('lostItems').textContent = lost;
            document.getElementById('foundItems').textContent = found;
            document.getElementById('matchedItems').textContent = matched;
            
            // Calculate most common lost items
            const itemCounts = {};
            allItems.filter(item => item.status === 'Lost').forEach(item => {
                const name = item.name.toLowerCase();
                itemCounts[name] = (itemCounts[name] || 0) + 1;
            });
            
            const topItems = Object.entries(itemCounts)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 3)
                .map(([name, count]) => `${name} (${count})`)
                .join(', ') || 'No data yet';
                
            document.getElementById('commonItems').textContent = topItems;
        }
        
        function displayAllItems() {
            document.getElementById('itemsList').innerHTML = allItems.map(item => 
                `<div style="border:1px solid #ddd; padding:15px; margin:10px 0; border-radius:8px; background:#f9f9f9;">
                    <strong style="color:#764ba2;">${item.name}</strong> 
                    <span style="background:${getStatusColor(item.status)}; color:white; padding:2px 8px; border-radius:12px; font-size:12px;">${item.status || 'Lost'}</span><br>
                    <strong>Description:</strong> ${item.description}<br>
                    <strong>Location:</strong> ${item.location} | <strong>Date:</strong> ${item.date}<br>
                    <strong>Contact:</strong> ${item.contact}
                    ${item.status !== 'Matched' && item.status !== 'Resolved' ? 
                        `<br><button onclick="updateItemStatus(${item.id}, 'Resolved')" style="background: #27ae60; margin-top: 10px;">Mark as Resolved</button>` : ''}
                </div>`
            ).join('');
        }
        
        function displayMatchingItems() {
            const lostItems = allItems.filter(item => item.status === 'Lost');
            const foundItems = allItems.filter(item => item.status === 'Found');
            
            document.getElementById('lostItemsList').innerHTML = lostItems.map(item => 
                `<div class="match-item" onclick="selectLostItem(${item.id})" id="lost-${item.id}">
                    <strong>${item.name}</strong><br>
                    ${item.description}<br>
                    <small>Location: ${item.location} | Date: ${item.date}</small>
                </div>`
            ).join('');
            
            document.getElementById('foundItemsList').innerHTML = foundItems.map(item => 
                `<div class="match-item" onclick="selectFoundItem(${item.id})" id="found-${item.id}">
                    <strong>${item.name}</strong><br>
                    ${item.description}<br>
                    <small>Location: ${item.location} | Date: ${item.date}</small>
                </div>`
            ).join('');
        }
        
        function selectLostItem(id) {
            if (selectedLostItem) {
                document.getElementById(`lost-${selectedLostItem}`).classList.remove('selected');
            }
            selectedLostItem = id;
            document.getElementById(`lost-${id}`).classList.add('selected');
        }
        
        function selectFoundItem(id) {
            if (selectedFoundItem) {
                document.getElementById(`found-${selectedFoundItem}`).classList.remove('selected');
            }
            selectedFoundItem = id;
            document.getElementById(`found-${id}`).classList.add('selected');
        }
        
        async function matchSelectedItems() {
            if (!selectedLostItem || !selectedFoundItem) {
                alert('Please select both a lost item and a found item to match.');
                return;
            }
            
            // Update both items to matched status
            await updateItemStatus(selectedLostItem, 'Matched');
            await updateItemStatus(selectedFoundItem, 'Matched');
            
            alert('Items matched successfully! Both parties will be contacted.');
            selectedLostItem = null;
            selectedFoundItem = null;
            loadItems();
        }
        
        async function updateItemStatus(itemId, newStatus) {
            const response = await fetch(`/api/items/${itemId}/status`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: newStatus })
            });
            if (response.ok) {
                loadItems();
            }
        }
        
        function getStatusColor(status) {
            switch(status) {
                case 'Found': return '#27ae60';
                case 'Matched': return '#f39c12';
                case 'Resolved': return '#9b59b6';
                default: return '#e74c3c';
            }
        }
        
        function showSection(section) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(section + 'Tab').classList.add('active');
            
            document.getElementById('reportSection').style.display = section === 'report' ? 'block' : 'none';
            document.getElementById('matchSection').style.display = section === 'match' ? 'block' : 'none';
            document.getElementById('allSection').style.display = section === 'all' ? 'block' : 'none';
        }
        
        function searchItems() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            const filtered = allItems.filter(item => 
                item.name.toLowerCase().includes(query) || 
                item.description.toLowerCase().includes(query)
            );
            
            document.getElementById('itemsList').innerHTML = filtered.map(item => 
                `<div style="border:1px solid #ddd; padding:15px; margin:10px 0; border-radius:8px; background:#f9f9f9;">
                    <strong style="color:#764ba2;">${item.name}</strong> 
                    <span style="background:${getStatusColor(item.status)}; color:white; padding:2px 8px; border-radius:12px; font-size:12px;">${item.status || 'Lost'}</span><br>
                    <strong>Description:</strong> ${item.description}<br>
                    <strong>Location:</strong> ${item.location} | <strong>Date:</strong> ${item.date}<br>
                    <strong>Contact:</strong> ${item.contact}
                </div>`
            ).join('');
        }
        
        loadItems();
    </script>
</body>
</html>